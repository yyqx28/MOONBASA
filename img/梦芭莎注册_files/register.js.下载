$(function () {
    var isRcmdMobile = false;

    $("#code_dialog").dialog({
        modal: true,
        title: '操作提示',
        width: 346,
        height: 165,
        autoOpen: false,
        showClose: false
    });
    $("#code_dialog").prev().css({
        "border": "1px solid #cbcbcb",
        "background": "#ec1865 url(http://i2.mbscss.com/img/member/20120807/ui-bg_highlight-soft_75_ec1865_1x100.png) 50% 50% repeat-x",
        "color": "#fff",
        "font-weight": "bold"
    });

    //手机邮箱注册验证
    $("#txtEmailOrMobile").blur(function () {
        $("#txtEmailOrMobileTip").html('');
        var mobileOrMobile = $("#txtEmailOrMobile").val();
        if (isRcmdMobile) {
            if (mobileOrMobile == "") {
                Validate.SetError('txtEmailOrMobile', '通过推荐注册，手机号不能为空');
            }
            else if (!ML.Validator.IsMobile(mobileOrMobile)) {
                Validate.SetError('txtEmailOrMobile', '您输入的手机号码不符合规范');
            }
            else {
            }
        }
        else {
            if (ML.Validator.IsEmptyOrNull(mobileOrMobile)) {
                Validate.SetError('txtEmailOrMobile', '请输入邮箱或手机号！');
            }
            else {
                if (!ML.Validator.IsEmail(mobileOrMobile) && !ML.Validator.IsMobile(mobileOrMobile)) {
                    Validate.SetError('txtEmailOrMobile', '您输入的邮箱或手机号码不符合规范！');
                } else {
                    $("#txtEmailOrMobileTip").removeClass('f_explain').text('');
                    //$('#txtEmailOrMobileCorrent').removeClass('i_correct');
                    $('#txtEmailOrMobile').removeClass('i_text_error');
                }
            }
        }
    });

    $("#txtCode").blur(function () {
        $("#txtCodeTip").html('');
        var txtCode = $("#txtCode").val();
        if (ML.Validator.IsEmptyOrNull(txtCode)) {
            Validate.SetError('txtCode', '请输入动态验证码！');
        } else if (txtCode.length != 6) {
            Validate.SetError('txtCode', '请输入6位验证码！');
        } else {
            Validate.SetCorrect('txtCode');
        }
    });

    //获取手机/邮箱的动态验证码
    $("#GetCode").click(function () {
        var flag = true;
        if (MLVerifyCode.ValToken()) {
            MLVerifyCode.SetVerifyCode("member_reg");
        } else {
            MLVerifyCode.SetHint(true, "页面已经过期,请刷新页面！");
        }

        var registerItem = $("#txtEmailOrMobile").val();
        var token = $("#token").val();
        var txtCode = $("#txtCode").val();

        if (ML.Validator.IsEmptyOrNull(registerItem)) {
            Validate.SetError('txtEmailOrMobile', "请输入邮箱或手机号！");
            flag = false;
        }
        else if (ML.Validator.IsMobile(registerItem) || ML.Validator.IsEmail(registerItem)) {
            Validate.SetError(false);
        }
        else {
            Validate.SetError('txtEmailOrMobile', "您输入的邮箱或手机号码不符合规范！");
            flag = false;
        }

        var result = MLVerifyCode.ValCode('member_reg');
        if (result == 0) {
            Validate.SetCorrect('member_reg_Code');
        }
        else if (result == -100) {
            Validate.SetError('member_reg_Code', '请输入验证码');
            flag = false;
        }
        else if (result == -101) {
            Validate.SetError('member_reg_Code', '请输入四位验证码');
            flag = false;
        }
        else if (result == -102) {
            Validate.SetError('member_reg_Code', '请输入正确的验证码');
            MLVerifyCode.ChangeVCode('member_reg', 0);
            flag = false;
        }
        else {
            Validate.SetError('member_reg_Code', '验证码已过期，请重新输入');
            MLVerifyCode.ChangeVCode('member_reg', 0);
            flag = false;
        }

        if (!flag) {
            return;
        }

        $("#GetCode").val("正在发送中……");
        $("#GetCode").attr('disabled', 'disabled');


        $.ajax({
            type: 'post',
            url: '/Home/SendRegisterCodeSms',
            data: { txtEmailOrMobile: registerItem, token: token },
            success: function (data) {
                if (data.Result == 1) {
                    //成功
                    $(".code_dialog_text").text(data.Msg);
                    $("#code_dialog").dialog('open');
                    setTimeout(function () {
                        $("#code_dialog").dialog('close')
                    }, 3000);
                    getCodeClick();
                } else {
                    //失败
                    MLVerifyCode.SetHint(true, data.Msg);
                    $("#GetCode").val("获取动态验证码");
                    $("#GetCode").removeAttr('disabled');
                    setTimeout(function () {
                        MLVerifyCode.SetHint(false);
                    }, 3000);
                }
            },
            error: function () {
                MLVerifyCode.SetHint(true, "数据传输异常，获取动态验证码失败！");
                $("#GetCode").val("获取动态验证码");
                $("#GetCode").removeAttr('disabled');
                setTimeout(function () {
                    MLVerifyCode.SetHint(false);
                }, 3000);
            }
        });
    });

    function getCodeClick() {
        $("#GetCode").addClass("i_btn_notClick");
        var s = parseInt($("#GetCode").attr("data-time"));
        $("#GetCode").attr('disabled', 'disabled');
        if (s > 1) {
            var ret = s - 1;
            $("#GetCode").attr("data-time", ret);
            $("#GetCode").val(ret + "秒后重新获取");
            setTimeout(getCodeClick, 1000);
        }
        else if (s == 1) {
            $("#GetCode").removeAttr('disabled');
            $("#GetCode").attr("data-time", 120);
            $("#GetCode").val("获取动态验证码");
            $("#GetCode").removeClass("i_btn_notClick");

        }
    }

    $("#txtRegPwd").blur(function () {
        var pwd = $("#txtRegPwd").val();
        var vpwdResult = VPWD.Check(pwd);
        if (ML.Validator.IsEmptyOrNull(pwd)) {
            Validate.SetError('txtRegPwd', '请输入8-20位字母和数字！');
        }
        else if (pwd.length < 8 || pwd.length > 20) {
            Validate.SetError('txtRegPwd', '密码请设为8-20位字母和数字！');
        }
        else if (vpwdResult == 1) {
            Validate.SetError('txtRegPwd', '密码太弱，有被盗风险，请设置为多种字符组成的复杂密码！');
        }
        else {
            Validate.SetCorrect('txtRegPwd');
            if (vpwdResult == 2) {
                $("#txtRegPwdTip").removeClass("f_explain").html('<div style="margin:5px;" class="ir icon-s-02"></div>');
            }
            else if (vpwdResult == 3) {
                $("#txtRegPwdTip").removeClass("f_explain").html('<div style="margin:5px;" class="ir icon-s-03"></div>');
            }
        }
    });
    $("#txtRegPwd").keyup(function () {
        var pwd = $("#txtRegPwd").val();
        if (pwd.length > 7) {
            var vpwdResult = VPWD.Check(pwd);
            if (vpwdResult == 2) {
                $("#txtRegPwdTip").removeClass("f_explain").html('<div style="margin:5px;" class="ir icon-s-02"></div>');
            }
            else if (vpwdResult == 3) {
                $("#txtRegPwdTip").removeClass("f_explain").html('<div style="margin:5px;" class="ir icon-s-03"></div>');
            }
        }
    });
    $("#txtConfirmPwd").blur(function () {
        var pwd = $("#txtRegPwd").val();
        var cpwd = $("#txtConfirmPwd").val();
        if (ML.Validator.IsEmptyOrNull(cpwd)) {
            Validate.SetError('txtConfirmPwd', '请再次输入密码！');
        }
        else if (pwd != cpwd) {
            Validate.SetError('txtConfirmPwd', '两次输入的密码不一致！');
        }
        else {
            Validate.SetCorrect('txtConfirmPwd');
        }
    });
    $("#txtRcmdMobile").blur(function () {
        var rcmdmobile = $("#txtRcmdMobile").val();
        isRcmdMobile = false;
        if (rcmdmobile == '') {
            $("#txtRcmdMobile").val('如无推荐人可不填写').css('color', '#888888');
        }

        if (rcmdmobile != "" && rcmdmobile != "如无推荐人可不填写") {
            if (ML.Validator.IsMobile(rcmdmobile)) {
                $.ajax({
                    type: 'post',
                    url: '/rcmdregister/getrcmd',
                    dataType: 'json',
                    data: { rcmdmobile: rcmdmobile },
                    success: function (str) {
                        if (typeof (str) != 'undefined') {
                            if (str.Result == 1) {
                                Validate.SetCorrect('txtRcmdMobile');
                                isRcmdMobile = true;

                                var mobile = $("#txtMobile").val();

                                if (mobile == "") {
                                    Validate.SetError('txtMobile', '通过推荐注册，手机号不能为空');
                                }
                                else if (!ML.Validator.IsMobile(mobile)) {
                                    Validate.SetError('txtMobile', '您输入的手机号码不符合规范');
                                }
                            }
                            else {
                                Validate.SetError('txtRcmdMobile', str.Msg);
                                $("#txtMobileTip").removeClass('f_explain').text('');
                                $("#txtMobile").removeClass('i_text_error');
                            }
                        }
                    }
                });
            }
            else {
                Validate.SetError('txtRcmdMobile', '您输入的手机号码不符合规范');
                $("#txtMobileTip").removeClass('f_explain').text('');
                $("#txtMobile").removeClass('i_text_error');
            }
        }
        else {
            $("#txtRcmdMobile").removeClass('i_text_error');
            $("#txtRcmdMobileTip").removeClass('f_explain').text('');
        }
    });
    $("#txtRcmdMobile").focus(function () {
        if ($("#txtRcmdMobile").val() == '如无推荐人可不填写') {
            $("#txtRcmdMobile").val('').css('color', '#000000');
        }
    });
    $("#member_reg_Code").blur(function () {
        var result = MLVerifyCode.ValCode('member_reg');

        if (result == "0") {
            Validate.SetCorrect('member_reg_Code');
            return true;
        }
        else if (result == -100) {
            Validate.SetError('member_reg_Code', '请输入验证码');
            isSubmit = false;
        }
        else if (result == -101) {
            Validate.SetError('member_reg_Code', '请输入四位验证码');
            isSubmit = false;
        }
        else if (result == -102) {
            Validate.SetError('member_reg_Code', '请输入正确的验证码');
            MLVerifyCode.ChangeVCode('member_reg', 0);
            isSubmit = false;
        }
        else {
            Validate.SetError('member_reg_Code', '验证码已过期，请重新输入');
            MLVerifyCode.ChangeVCode('member_reg', 0);
            isSubmit = false;
        }
    });

    $('#member_reg_ValImg').live('click', function () {
        if (MLVerifyCode.ValToken()) {
            MLVerifyCode.ChangeVCode('member_reg', 1);
        } else {
            MLVerifyCode.SetHint(true, "页面已经过期,请刷新页面！");
        }
    });
    $("#aRegChgVCode,#member_reg_ValImg").click(function () {
        if (MLVerifyCode.ValToken()) {
            MLVerifyCode.ChangeVCode('member_reg', 1);
        } else {
            MLVerifyCode.SetHint(true, "页面已经过期,请刷新页面！");
        }
    });
    /*用户注册*/
    $("#btnRegister").click(function () {
        MLVerifyCode.SetVerifyCode("member_reg");
        var isSubmit = true;

        var mobileOrMobile = $("#txtEmailOrMobile").val();
        var pwd = $("#txtRegPwd").val();
        var cpwd = $("#txtConfirmPwd").val();
        var txtCode = $("#txtCode").val();

        if ($('#J_rmb_btn')[0].checked == false) {
            alert('请勾选“同意梦芭莎注册条款”');
            isSubmit = false;
        }


        if (ML.Validator.IsEmptyOrNull(mobileOrMobile)) {
            Validate.SetError('txtEmailOrMobile', '请输入邮箱或手机号码！');
            isSubmit = false;
        }
        else if (!ML.Validator.IsEmail(mobileOrMobile) && !ML.Validator.IsMobile(mobileOrMobile)) {
            Validate.SetError('txtEmailOrMobile', '您输入的邮箱或手机号码不符合规范！');
            isSubmit = false;
        }
        else if (ML.Validator.IsEmptyOrNull(mobileOrMobile) == false && (ML.Validator.IsEmail(mobileOrMobile) || ML.Validator.IsMobile(mobileOrMobile))) {
            Validate.SetCorrect('txtEmailOrMobile');
        }
        //else if (ML.Validator.IsEmptyOrNull(mobileOrMobile) == false && ML.Validator.IsMobile(mobileOrMobile)) {
        //Validate.SetCorrect('txtEmailOrMobile');
        //}


        if (ML.Validator.IsEmptyOrNull(txtCode)) {
            Validate.SetError('txtCode', '请输入动态验证码！');
            isSubmit = false;
        } else if (txtCode.length != 6) {
            Validate.SetError('txtCode', '请输入6位验证码！');
            isSubmit = false;
        } else {
            Validate.SetCorrect('txtCode');
        }

        var vpwdResult = VPWD.Check(pwd);
        if (ML.Validator.IsEmptyOrNull(pwd)) {
            Validate.SetError('txtRegPwd', '请输入8-20位字母或数字！');
            isSubmit = false;
        }
        else if (pwd.length < 8 || pwd.length > 20) {
            Validate.SetError('txtRegPwd', '密码请设为8-20位字母或数字！');
            isSubmit = false;
        }
        else if (vpwdResult == 1) {
            Validate.SetError('txtRegPwd', '密码太弱，有被盗风险，请设置为多种字符组成的复杂密码！');
            isSubmit = false;
        }
        else {
            Validate.SetCorrect('txtRegPwd');
            if (vpwdResult == 2) {
                $("#txtRegPwdTip").removeClass("f_explain").html('<div style="margin:5px;" class="ir icon-s-02"></div>');
            }
            else if (vpwdResult == 3) {
                $("#txtRegPwdTip").removeClass("f_explain").html('<div style="margin:5px;" class="ir icon-s-03"></div>');
            }
        }

        if (ML.Validator.IsEmptyOrNull(cpwd)) {
            Validate.SetError('txtConfirmPwd', '请再次输入密码！');
            isSubmit = false;
        }
        else if (pwd != cpwd) {
            Validate.SetError('txtConfirmPwd', '两次输入的密码不一致');
            isSubmit = false;
        }

        var rcmdmobile = $("#txtRcmdMobile").val();

        if (rcmdmobile != "" && rcmdmobile != "如无推荐人可不填写") {
            if (ML.Validator.IsMobile(rcmdmobile)) {

                if (mobile == "") {
                    Validate.SetError('txtMobile', '通过推荐注册，手机号不能为空');
                }
                else if (!ML.Validator.IsMobile(mobile)) {
                    Validate.SetError('txtMobile', '您输入的手机号码不符合规范');
                }
                else {
                    $.ajax({
                        type: 'post',
                        async: false,
                        url: '/rcmdregister/getrcmd',
                        dataType: 'json',
                        data: { rcmdmobile: rcmdmobile },
                        success: function (str) {
                            if (typeof (str) != 'undefined') {
                                if (str.Result == 1) {
                                    Validate.SetCorrect('txtRcmdMobile');
                                }
                                else {
                                    Validate.SetError('txtRcmdMobile', str.Msg);
                                }
                            }
                        }
                    });
                }
            }
            else {
                Validate.SetError('txtRcmdMobile', '您输入的手机号码不符合规范');
            }
        }
        else {
            $("#txtRcmdMobile").removeClass('i_text_error');
            $("#txtRcmdMobileTip").removeClass('f_explain').text('');
        }

        var result = MLVerifyCode.ValCode('member_reg');
        if (result == 0) {
            Validate.SetCorrect('member_reg_Code');
        }
        else if (result == -100) {
            Validate.SetError('member_reg_Code', '请输入验证码');
            isSubmit = false;
        }
        else if (result == -101) {
            Validate.SetError('member_reg_Code', '请输入四位验证码');
            isSubmit = false;
        }
        else if (result == -102) {
            Validate.SetError('member_reg_Code', '请输入正确的验证码');
            MLVerifyCode.ChangeVCode('member_reg', 0);
            isSubmit = false;
        }
        else {
            Validate.SetError('member_reg_Code', '验证码已过期，请重新输入');
            MLVerifyCode.ChangeVCode('member_reg', 0);
            isSubmit = false;
        }

        if (isSubmit == false) {
            return false;
        }
        else {
            $("#btnRegister").attr('disabled', 'disabled').removeClass('i_btn_ok').addClass('i_btn_disabled').val('注册中...');
            $("#loginMsg").hide();
            $.ajax({
                type: 'post',
                url: '/home/userregister',
                data: $("#form").serialize(),
                success: function (str) {
                    $("#btnRegister").removeAttr("disabled").removeClass('i_btn_disabled').addClass('i_btn_ok').val('注册');

                    MLVerifyCode.ChangeVCode('member_reg', 1);

                    $("#txt_RegCodeTip").html('');
                    $("#member_reg_Code").val('');

                    if (typeof (str.Result) == "undefined") {
                        MLVerifyCode.SetHint(true, "系统异常，请稍后再试！");
                    }
                    else {
                        if (str.Result == 1) {
                            if (str.IsRcmd) {
                                $("#bMobile").text(mobile);
                                $("#dialogRcmd").dialog('open');
                            }
                            else {
                                $("#dialog").dialog('open');
                                MLLogin.Redirect();
                            }
                        }
                        else {
                            MLVerifyCode.SetHint(true, str.Msg);
                        }
                    }
                },
                error: function () {
                    MLVerifyCode.SetHint(true, "数据传输异常，注册失败！");
                }
            });
        }
    });
    $("#dRegister").keypress(function (event) {
        if (event.keyCode == 13) {
            $("#btnRegister").click();
        }
    });
    $("#dialog").dialog({
        modal: true,
        title: '系统提示',
        width: 300,
        height: 160,
        autoOpen: false,
        showClose: false
    });
    $("#dialogRcmd").dialog({
        modal: true,
        width: 520,
        height: 450,
        autoOpen: false,
        close: function (event, ui) {
            MLLogin.Redirect();
        }
    });

    MLVerifyCode.SetVerifyHtml("member_reg");
});

var MLLogin = {
    Redirect: function () {
        var location = document.referrer.toLowerCase();

        var redirecturl = '/home/registersuccess';

        if (location.indexOf("http://shopping.moonbasa.com") == 0) {
            redirecturl = location;
        }
        else if (location.indexOf("http://all.moonbasagroup.com:30331") == 0) {
            redirecturl = location;
        }

        window.location.href = redirecturl;
    }
}

var Rcmd = {
    SendSms: function () {
        $.ajax({
            type: 'post',
            url: '/rcmdregister/sendsmsverifycode',
            success: function (str) {
                if (typeof (str) != 'undefined') {
                    if (str.Result == "1") {
                        $("#mobilevcode").removeAttr('disabled');
                        $("#resetSend").show();
                        $("#sResend").show();

                        Rcmd.Min();
                    }
                    else {
                        alert(str.Msg);
                    }
                }
            }
        });
    },
    CheckSms: function () {
        var verifyCode = $("#mobilevcode").val();

        if (verifyCode == "") {
            alert("短信校验码不能为空！");
        }
        else {
            $.ajax({
                type: 'post',
                url: '/rcmdregister/checksmsverifycode',
                dataType: 'json',
                data: { verifyCode: verifyCode },
                success: function (str) {
                    if (typeof (str) != 'undefined') {
                        if (str.Result == "1") {
                            var html = '<div class="tc_01" style="padding-top:20px;height:334px;">';
                            html += '<div class="tc_item tc_item1" style="text-align:left;">恭喜您成功参与“推荐好友，1000元分享”活动！</div>';
                            html += '<div class="tc_item tc_item1" style="text-align:left;">获赠50元好友分享礼券（满200使用）已加入您的梦芭莎账户！</div>';
                            html += '<div class="tc_item tc_item1" style="text-align:left;">立即登录<a href="' + MemberDomain + '" style="text-decoration:underline"><b style="color:Red; font-size:13px;">我的梦芭莎</b></a>——<a style="text-decoration:underline" href="' + MemberDomain + '/promotion/list"><b style="color:Red; font-size:13px;">促销活动</b></a>查询。</div>';
                            html += '</div>';

                            $("#dialogRcmd").html(html);
                        }
                        else {
                            alert(str.Msg);
                        }
                    }
                }
            });
        }
    },
    Min: function () {
        var s = parseInt($("#sMin").text());
        if (s > 1) {
            $("#sMin").text(s - 1);
            setTimeout(Rcmd.Min, 1000);
        }
        else if (s == 1) {
            $("#resetSend").hide();
            $("#sMin").text('60');
        }
    }
}

